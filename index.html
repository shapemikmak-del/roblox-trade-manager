<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Roblox Trade Manager â€” ×“×£ × ×™×”×•×œ ××›×™×¨×•×ª</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #0f1113;
  --card: #121418;
  --accent: #00ffcc;
  --accent-2: #2f7eff;
  --accent-3: #00c853;
  --danger: #ff3b30;
  --muted: #9aa3b2;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:'Rubik',sans-serif;color:#e6eef7}
.header{
  display:flex;gap:16px;align-items:center;justify-content:space-between;padding:18px 22px;background:linear-gradient(90deg,#071021,#0d1220);
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#2f7eff,#00ffcc);
  display:flex;align-items:center;justify-content:center;font-weight:700;color:#041126;font-size:18px;
  box-shadow:0 6px 20px rgba(47,126,255,0.12), inset 0 -6px 12px rgba(0,0,0,0.25);
}
.title{font-size:18px;font-weight:600}
.header-actions{display:flex;gap:10px;align-items:center}

/* layout */
.main{
  padding:18px;
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:18px;
}
@media(max-width:980px){
  .main{grid-template-columns:1fr; padding:12px}
}

/* left column controls */
.panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.02)}
.panel h3{margin:0 0 12px 0;color:var(--accent);font-size:16px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:inherit;margin-bottom:8px}
.row{display:flex;gap:8px}
.small{flex:1}
.btn{padding:10px;border-radius:8px;border:none;font-weight:600;cursor:pointer}
.btn.green{background:linear-gradient(90deg,var(--accent-3),#0ab46a);color:#01120b}
.btn.blue{background:linear-gradient(90deg,var(--accent-2),#3b6eff);color:white}
.btn.red{background:linear-gradient(90deg,#ff5b5b,#ff3b30);color:white}
.controls-footer{display:flex;flex-direction:column;gap:8px;margin-top:8px}

/* right column: dashboard */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
}
@media(max-width:1200px){ .grid{grid-template-columns:1fr} }

.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 10px 30px rgba(2,6,23,0.6);
}
.card h4{margin:0 0 10px 0;color:#cbeef2}

/* summary strip */
.summary{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
.summary .item{background:#071019;padding:10px;border-radius:10px;min-width:140px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
.summary .item .num{font-weight:700;color:var(--accent);font-size:20px}
.summary .item .sub{font-size:12px;color:var(--muted)}

/* tables */
.table{width:100%;border-collapse:collapse;margin-top:10px;color:#dbeefc;font-size:14px}
.table th, .table td{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,0.02);text-align:center}
.table th{font-size:13px;color:var(--muted)}
.actions-btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}

/* search/filter row */
.search-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.search-row .input{flex:1}

/* footer controls */
.bottom-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}

/* charts area full width */
.charts{grid-column:1 / -1;display:grid;gap:12px}
.canvas-wrap{padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}

/* responsive tweaks */
@media(max-width:600px){
  .summary .item{min-width:100px}
  .brand .title{display:none}
}






/* ×›×¤×ª×•×¨ × ×’×™×©×•×ª ×§×‘×•×¢ */
#accessibility-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  background: #007acc;
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 24px;
  cursor: pointer;
}

/* ×—×œ×•× ×™×ª ×¦×“×“×™×ª */
#accessibility-panel {
  position: fixed;
  top: 0;
  right: -320px;
  width: 320px;
  height: 100%;
  background: var(--card);
  color: #e6eef7;
  box-shadow: -4px 0 15px rgba(0,0,0,0.6);
  padding: 20px;
  transition: right 0.3s ease;
  z-index: 9998;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}
#accessibility-panel.open { right: 0; }

.accessibility-option { margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; }
.accessibility-option button {
  padding: 10px;
  border-radius: 6px;
  border: none;
  background: #007acc;
  color: white;
  font-size: 1em;
  cursor: pointer;
}
.accessibility-option button.active { background: #00ffcc; color: #000; }

#close-panel {
  margin-top: auto;
  background: #ff3b30;
}



/* login modal */
#loginModal {
  position: fixed; top:0; left:0; width:100%; height:100%; display:flex;
  justify-content:center; align-items:center; background: rgba(0,0,0,0.7); z-index:9999;
}
#loginModal .panel { width:300px; }


.hidden {
  display: none !important;
}


.logout-btn {
  background: linear-gradient(90deg, #ff5757, #ff3b30);
  color: white;
  font-weight: 600;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  transition: all 0.2s ease;
}

.logout-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.5);
}

.logout-btn:active {


</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">RBX</div>
    <div>
      <div class="title">Roblox Trade Manager</div>
      <div style="font-size:12px;color:var(--muted)">× ×™×”×•×œ ×§× ×™×•×ª ×•××›×™×¨×•×ª â€” ×’×¨×¡×” ××§×¦×•×¢×™×ª</div>
    </div>
	
  </div>
  
  <button id="logoutBtn" class="btn logout-btn hidden">×”×ª× ×ª×§</button>

</header>


<!-- LOGIN MODAL -->
<div id="loginModal">
  <div class="panel card">
    <h3>×”×ª×—×‘×¨×•×ª / ×”×¨×©××”</h3>
    <input id="emailInput" class="input" type="email" placeholder="××™××™×™×œ" />
    <input id="passInput" class="input" type="password" placeholder="×¡×™×¡××”" />
    <div class="row">
      <button id="loginBtn" class="btn blue small">×”×ª×—×‘×¨</button>
      <button id="registerBtn" class="btn green small">×”×™×¨×©×</button>
    </div>
    <div id="loginError" style="color:#ff3b30;margin-top:8px;font-size:13px"></div>
  </div>
</div>

<!-- ×›×¤×ª×•×¨ × ×’×™×©×•×ª -->
<button id="accessibility-btn" aria-label="×¤×ª×— ×ª×¤×¨×™×˜ × ×’×™×©×•×ª" title="× ×’×™×©×•×ª">ğŸ› ï¸</button>

<!-- ×—×œ×•× ×™×ª ×¦×“×“×™×ª -->
<div id="accessibility-panel" role="dialog" aria-labelledby="accessibility-title" aria-describedby="accessibility-desc" aria-hidden="true">
  <h2 id="accessibility-title">×ª×¤×¨×™×˜ × ×’×™×©×•×ª</h2>
  <p id="accessibility-desc">×›×œ×™ × ×’×™×©×•×ª ×œ×©×™×¤×•×¨ ×—×•×•×™×™×ª ×”××©×ª××© ×‘××ª×¨</p>

  <div class="accessibility-option">
    <button id="toggle-contrast">× ×™×’×•×“×™×•×ª ×’×‘×•×”×”</button>
    <button id="toggle-dark">××¦×‘ ×›×”×”</button>
  </div>

  <div class="accessibility-option">
    <button id="increase-text">×”×’×“×œ ×˜×§×¡×˜</button>
    <button id="decrease-text">×”×§×˜×Ÿ ×˜×§×¡×˜</button>
    <button id="increase-buttons">×”×’×“×œ ×›×¤×ª×•×¨×™×</button>
    <button id="reset-buttons">××¤×¡ ×’×•×“×œ ×›×¤×ª×•×¨×™×</button>
  </div>

  <div class="accessibility-option">
    <button id="read-text">×”×§×¨× ×˜×§×¡×˜</button>
  </div>

  <button id="close-panel" aria-label="×¡×’×•×¨ ×—×œ×•× ×™×ª">âœ–ï¸</button>
</div>

<main class="main">
  <!-- LEFT: CONTROLS -->
  <section>
    <div class="panel card">
      <h3>×”×•×¡×£ ×¢×¡×§×” ×—×“×©×”</h3>
      <input id="inputItem" class="input" placeholder="×©× ×¤×¨×™×˜" />
      <div class="row">
        <input id="inputPrice" type="number" class="input small" placeholder="××—×™×¨ (â‚ª)" />
        <input id="inputDate" type="date" class="input small" />
      </div>
      <div class="row">
        <button id="btnBuy" class="btn green">×”×•×¡×£ ×§× ×™×™×”</button>
        <button id="btnSell" class="btn blue">×”×•×¡×£ ××›×™×¨×”</button>
      </div>
      <div class="controls-footer">
        <label style="font-size:13px;color:var(--muted)">×›×œ×™ × ×ª×•× ×™×</label>
        <input id="importFile" type="file" accept=".json" />
        <div style="display:flex;gap:8px;margin-top:4px">
          <button id="btnExport" class="btn" style="background:#0b1220;color:var(--accent)">×™×™×¦× JSON</button>
          <button id="btnClear" class="btn red">× ×§×” × ×ª×•× ×™×</button>
        </div>
      </div>
    </div>

    <div class="panel card" style="margin-top:14px">
      <h3>×—×™×¤×•×© ×•×¤×™×œ×˜×¨</h3>
      <div class="search-row">
        <input id="searchBox" class="input" placeholder="×—×¤×© ×œ×¤×™ ×©× ×¤×¨×™×˜..." />
      </div>
      <div class="row">
        <input id="filterFrom" type="date" class="input small" />
        <input id="filterTo" type="date" class="input small" />
      </div>
      <div style="margin-top:8px">
        <button id="btnFilter" class="btn" style="background:#1b2738;color:var(--accent)">×”×—×œ ×¡×™× ×•×Ÿ</button>
        <button id="btnResetFilter" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);margin-left:8px">××™×¤×•×¡</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: DASHBOARD -->
  <section>
    <div class="grid">
      <!-- SUMMARY -->
      <div class="card">
        <h4>×¡×™×›×•× ××”×™×¨</h4>
        <div class="summary">
          <div class="item"><div class="num" id="totalProfit">0 â‚ª</div><div class="sub">×¨×•×•×— ×›×•×œ×œ</div></div>
          <div class="item"><div class="num" id="totalSpent">0 â‚ª</div><div class="sub">×¡×”"×› ×§× ×™×•×ª</div></div>
          <div class="item"><div class="num" id="totalEarned">0 â‚ª</div><div class="sub">×¡×”"×› ××›×™×¨×•×ª</div></div>
          <div class="item"><div class="num" id="countBought">0</div><div class="sub">×›××•×ª ×§× ×™×•×ª</div></div>
          <div class="item"><div class="num" id="countSold">0</div><div class="sub">×›××•×ª ××›×™×¨×•×ª</div></div>
        </div>
      </div>

      <!-- TRANSACTIONS TABLE -->
      <div class="card">
        <h4>×¨×©×™××ª ×¢×¡×§××•×ª</h4>
        <table class="table" id="txTable">
          <thead><tr><th>×¡×•×’</th><th>×¤×¨×™×˜</th><th>××—×™×¨ â‚ª</th><th>×ª××¨×™×š</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
          <tbody id="txBody"></tbody>
        </table>
        <div class="bottom-actions">
          <div style="flex:1;color:var(--muted);font-size:13px">×ª×•×¦××•×ª: <span id="txCount">0</span></div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="card charts">
        <h4>×’×¨×¤×™× ×•× ×™×ª×•×—×™×</h4>

        <div class="canvas-wrap card" style="padding:12px">
          <div style="font-weight:600;color:var(--muted);margin-bottom:8px">×¨×•×•×— ×™×•××™ (××›×™×¨×•×ª âˆ’ ×§× ×™×•×ª)</div>
          <canvas id="profitChart" height="120"></canvas>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="canvas-wrap card">
            <div style="font-weight:600;color:var(--muted);margin-bottom:8px">×”×•×¦××•×ª ×™×•××™×•×ª (×§× ×™×•×ª)</div>
            <canvas id="expensesChart" height="120"></canvas>
          </div>
          <div class="canvas-wrap card">
            <div style="font-weight:600;color:var(--muted);margin-bottom:8px">××›×™×¨×•×ª ×™×•××™×•×ª</div>
            <canvas id="salesChart" height="120"></canvas>
          </div>
        </div>

       
      </div>
    </div>
  </section>
</main>
<script type="module">
/* ===========================
   Imports (×—×•×‘×” ×œ×”×™×•×ª ×‘×¨××© ×”××•×“×•×œ)
   =========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  getDocs,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  where,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

/* ===========================
   Firebase config + init
   =========================== */
const firebaseConfig = {
  apiKey: "AIzaSyC9iwUh78agY9sGsX8VebSVfD1ouzqt0Z4",
  authDomain: "dashboard-shop-firebase.firebaseapp.com",
  projectId: "dashboard-shop-firebase",
  storageBucket: "dashboard-shop-firebase.appspot.com",
  messagingSenderId: "294205503847",
  appId: "1:294205503847:web:f070c8b02e3eb034fe17c2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===========================
   Global state
   =========================== */
const STORAGE_KEY = 'roblox_trade_data_v1';
let transactions = [];           // ×¨×©×™××ª ×”×¢×¡×§××•×ª ×”× ×•×›×—×™×ª (×œ××©×ª××© ×”××—×•×‘×¨)
let currentUserUID = null;       // uid ×©×œ ×”××©×ª××© ×”××—×•×‘×¨
let transactionsUnsubscribe = null; // ×¤×•×™× ×˜×¨ ×œÖ¾onSnapshot unsubscribe
let filtered = null;             // × ×ª×•× ×™× ××¡×•× × ×™× (UI)

/* ===========================
   Utilities
   =========================== */
const uid = () => 't' + Math.random().toString(36).slice(2, 10);
const pad = n => n.toString().padStart(2, '0');
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
};
const fmt = v => (Number(v) || 0).toLocaleString('he-IL');

/* ===========================
   DOMContentLoaded â€” ×›×œ ×”×§×•×“ ×”×ª×œ×•×™ ×‘-DOM ×¤×”
   =========================== */
window.addEventListener('DOMContentLoaded', () => {

  // --- DOM Elements ---
  const btn = document.getElementById('accessibility-btn');
  const panel = document.getElementById('accessibility-panel');
  const closePanel = document.getElementById('close-panel');
  const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
  let lastFocused;

  const inputItem = document.getElementById('inputItem');
  const inputPrice = document.getElementById('inputPrice');
  const inputDate = document.getElementById('inputDate');
  const btnBuy = document.getElementById('btnBuy');
  const btnSell = document.getElementById('btnSell');
  const btnExport = document.getElementById('btnExport');
  const btnClear = document.getElementById('btnClear');
  const importFile = document.getElementById('importFile');
  const searchBox = document.getElementById('searchBox');
  const filterFrom = document.getElementById('filterFrom');
  const filterTo = document.getElementById('filterTo');
  const btnFilter = document.getElementById('btnFilter');
  const btnResetFilter = document.getElementById('btnResetFilter');

  const txBody = document.getElementById('txBody');
  const txCount = document.getElementById('txCount');
  const totalProfit = document.getElementById('totalProfit');
  const totalSpent = document.getElementById('totalSpent');
  const totalEarned = document.getElementById('totalEarned');
  const countBought = document.getElementById('countBought');
  const countSold = document.getElementById('countSold');

  const contrastBtn = document.getElementById('toggle-contrast');
  const darkBtn = document.getElementById('toggle-dark');
  const increaseTextBtn = document.getElementById('increase-text');
  const decreaseTextBtn = document.getElementById('decrease-text');
  const btnIncrease = document.getElementById('increase-buttons');
  const btnReset = document.getElementById('reset-buttons');
  const readTextBtn = document.getElementById('read-text');

  const loginModal = document.getElementById('loginModal');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('registerBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passInput');

  // --- Accessibility panel behavior ---
  btn?.addEventListener('click', () => {
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
    lastFocused = document.activeElement;
    const f = panel.querySelector(focusableSelectors);
    if (f) f.focus();
  });

  closePanel?.addEventListener('click', () => {
    panel.classList.remove('open');
    panel.setAttribute('aria-hidden', 'true');
    lastFocused?.focus();
  });

  panel?.addEventListener('keydown', e => {
    if (e.key === 'Escape') closePanel?.click();
    if (e.key === 'Tab') {
      const focusable = Array.from(panel.querySelectorAll(focusableSelectors));
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
  });

  // --- Accessibility controls ---
  contrastBtn?.addEventListener('click', () => {
    document.body.classList.toggle('high-contrast');
    contrastBtn.classList.toggle('active');
  });

  darkBtn?.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    darkBtn.classList.toggle('active');
  });

  let fontSize = 100;
  increaseTextBtn?.addEventListener('click', () => {
    fontSize += 10;
    document.body.style.fontSize = fontSize + '%';
  });
  decreaseTextBtn?.addEventListener('click', () => {
    fontSize = Math.max(50, fontSize - 10);
    document.body.style.fontSize = fontSize + '%';
  });

  btnIncrease?.addEventListener('click', () => {
    document.querySelectorAll('button').forEach(b => b.style.fontSize = '1.2em');
  });
  btnReset?.addEventListener('click', () => {
    document.querySelectorAll('button').forEach(b => b.style.fontSize = '1em');
  });

  readTextBtn?.addEventListener('click', () => {
    const text = document.body.innerText;
    const utterance = new SpeechSynthesisUtterance(text);
    speechSynthesis.speak(utterance);
  });

  // --- Charts placeholders (××•×›× ×™× ×‘×§×•×“ ×©×œ×š) ---
  let profitChart, expensesChart, salesChart;
  function initCharts() {
    // ×™×© ×œ×”×©××™×¨ ×›×¤×™ ×©×”×™×” (×”× ×—×ª×™ ×©-Chart.js ×˜×¢×•×Ÿ ×‘×“×£)
    profitChart = new Chart(document.getElementById('profitChart').getContext('2d'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: '×¨×•×•×— ×™×•××™ (â‚ª)', data: [], borderColor: '#00ffcc', backgroundColor: 'rgba(0,255,204,0.08)', tension: 0.2, fill: true, pointRadius: 4 }] },
      options: { plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#dbeefc' } }, x: { ticks: { color: '#9aa3b2' } } } }
    });

    expensesChart = new Chart(document.getElementById('expensesChart').getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ label: '×”×•×¦××•×ª ×™×•××™×•×ª', data: [], backgroundColor: '#ff9b9b' }] },
      options: { plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#dbeefc' } }, x: { ticks: { color: '#9aa3b2' } } } }
    });

    salesChart = new Chart(document.getElementById('salesChart').getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ label: '××›×™×¨×•×ª ×™×•××™×•×ª', data: [], backgroundColor: '#9be0ff' }] },
      options: { plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#dbeefc' } }, x: { ticks: { color: '#9aa3b2' } } } }
    });
  }

  // --- Local storage (×©××¨×ª×™ ×¡×˜×•×‘×™× â€” ×ª×•×›×œ ×œ×”×¨×—×™×‘) ---
  function saveLocal() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions)); } catch (e) { /* silent */ }
  }
  function loadLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) transactions = JSON.parse(raw);
    } catch (e) { transactions = []; }
  }

  // --- Rendering / Summary / Filtering ---
  function renderTable(data) {
    txBody.innerHTML = '';
    (data || []).forEach(tx => {
      const tr = document.createElement('tr');

      const tdType = document.createElement('td');
      tdType.innerHTML = tx.type === 'buy' ? '<strong style="color:#ff9b9b">×§× ×™×™×”</strong>' :
        '<strong style="color:#9be0ff">××›×™×¨×”</strong>';
      tr.appendChild(tdType);

      const tdItem = document.createElement('td'); tdItem.textContent = tx.item; tr.appendChild(tdItem);
      const tdPrice = document.createElement('td'); tdPrice.textContent = fmt(tx.price); tr.appendChild(tdPrice);
      const tdDate = document.createElement('td'); tdDate.textContent = tx.date; tr.appendChild(tdDate);

      const tdActions = document.createElement('td');
      const btnE = document.createElement('button'); btnE.textContent = '×¢×¨×•×š'; btnE.className = 'actions-btn';
      btnE.onclick = () => openEditModal(tx);
      tdActions.appendChild(btnE);

      const btnD = document.createElement('button'); btnD.textContent = '××—×§'; btnD.className = 'actions-btn';
      btnD.style.marginInlineStart = '6px';
      btnD.style.background = 'linear-gradient(90deg,#ff5757,#ff3b30)';
      btnD.style.color = 'white';
      btnD.onclick = () => { if (confirm('×œ××—×•×§ ××ª ×”×¢×¡×§×”?')) deleteTransaction(tx.id); };
      tdActions.appendChild(btnD);

      tr.appendChild(tdActions);
      txBody.appendChild(tr);
    });
    txCount.textContent = (data || []).length;
  }

  function updateSummary(data) {
    const arr = data || transactions;
    const countB = arr.filter(tx => tx.type === 'buy').length;
    const countS = arr.filter(tx => tx.type === 'sell').length;
    const totalBought = arr.filter(tx => tx.type === 'buy').reduce((sum, tx) => sum + tx.price, 0);
    const totalSold = arr.filter(tx => tx.type === 'sell').reduce((sum, tx) => sum + tx.price, 0);
    const profit = totalSold - totalBought;

    countBought.textContent = countB;
    countSold.textContent = countS;
    totalSpent.textContent = fmt(totalBought) + ' â‚ª';
    totalEarned.textContent = fmt(totalSold) + ' â‚ª';
    totalProfit.textContent = fmt(profit) + ' â‚ª';
  }

  function groupByDate(arr) {
    const map = {};
    arr.forEach(tx => {
      if (!map[tx.date]) map[tx.date] = { spent: 0, earned: 0 };
      if (tx.type === 'buy') map[tx.date].spent += tx.price;
      else map[tx.date].earned += tx.price;
    });
    return map;
  }

  function updateChartsFromData(data) {
    const arr = data || transactions;
    const map = groupByDate(arr);
    const dates = Object.keys(map).sort((a, b) => new Date(a) - new Date(b));

    if (profitChart) {
      profitChart.data.labels = dates;
      profitChart.data.datasets[0].data = dates.map(d => map[d].earned - map[d].spent);
      profitChart.update();
    }
    if (expensesChart) {
      expensesChart.data.labels = dates;
      expensesChart.data.datasets[0].data = dates.map(d => map[d].spent);
      expensesChart.update();
    }
    if (salesChart) {
      salesChart.data.labels = dates;
      salesChart.data.datasets[0].data = dates.map(d => map[d].earned);
      salesChart.update();
    }
  }

  function getFilteredData() {
    const q = (searchBox?.value || '').trim().toLowerCase();
    const from = filterFrom?.value;
    const to = filterTo?.value;
    let data = transactions.slice();
    if (q) data = data.filter(tx => (tx.item || '').toString().toLowerCase().includes(q));
    if (from) data = data.filter(tx => tx.date >= from);
    if (to) data = data.filter(tx => tx.date <= to);
    return data;
  }

  function applyFilters() {
    filtered = getFilteredData();
    renderTable(filtered);
    updateSummary(filtered);
    updateChartsFromData(filtered);
  }

  function resetFilters() {
    if (searchBox) searchBox.value = '';
    if (filterFrom) filterFrom.value = '';
    if (filterTo) filterTo.value = '';
    filtered = null;
    refreshUI();
  }

  // --- Edit modal placeholder ---
  function openEditModal(tx) {
    const newPrice = prompt('×¢×¨×•×š ××—×™×¨:', tx.price);
    if (newPrice !== null) editTransaction(tx.id, { price: Number(newPrice) });
  }

  // --- Clean inputs ---
  function cleanAfterAction() {
    if (inputItem) inputItem.value = '';
    if (inputPrice) inputPrice.value = '';
    if (inputDate) inputDate.value = '';
  }

  // --- Event bindings UI ---
  btnBuy?.addEventListener('click', () => {
    if (inputItem?.value && inputPrice?.value) addTransaction('buy', inputItem.value, inputPrice.value, inputDate.value || todayISO());
  });
  btnSell?.addEventListener('click', () => {
    if (inputItem?.value && inputPrice?.value) addTransaction('sell', inputItem.value, inputPrice.value, inputDate.value || todayISO());
  });
  btnClear?.addEventListener('click', () => {
    if (confirm('×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?')) {
      // ××§×•××™ ×‘×œ×‘×“ (×× ×¨×•×¦×™× ×œ××—×•×§ ×‘-Firestore â€” ×¦×¨×™×š ×œ×•×œ××” ×¢× delete)
      transactions = [];
      saveLocal();
      refreshUI();
    }
  });
  searchBox?.addEventListener('input', applyFilters);
  btnFilter?.addEventListener('click', applyFilters);
  btnResetFilter?.addEventListener('click', resetFilters);

  // --- Refresh UI ××¨×•×›×–×ª ---
  function refreshUI() {
    renderTable(filtered || transactions);
    updateSummary(filtered || transactions);
    updateChartsFromData(filtered || transactions);
  }

  // ×”×ª×—×œ×ª ×ª×¨×©×™××™× ×•×˜×¢×™× ×ª ××§×•××™
  initCharts();
  loadLocal();
  refreshUI();

  /* ===========================
     Firestore: listeners + CRUD (users/<uid>/transactions)
     =========================== */

  // ×××–×™×Ÿ ×‘×–××Ÿ ×××ª ×œÖ¾transactions ×©×œ ×”××©×ª××© ×”× ×•×›×—×™
  function listenToUserTransactions(uidToListen) {
    // ×‘×˜×— ×©×”×¤×¢×œ× ×• unsubscribe ×§×•×“×
    if (transactionsUnsubscribe) {
      transactionsUnsubscribe();
      transactionsUnsubscribe = null;
    }
    if (!uidToListen) return;

    const txCollection = collection(db, "users", uidToListen, "transactions");
    const q = query(txCollection, orderBy("date", "desc"));

    transactionsUnsubscribe = onSnapshot(q, snapshot => {
      transactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      // ××•×¤×¦×™×•× ×œ×™: ×©××™×¨×ª ××§×•××™×ª
      saveLocal();
      refreshUI();
    }, err => {
      console.error('onSnapshot error:', err);
    });
  }

  // ×”×•×¡×¤×ª ×¢×¡×§×” ×‘-subcollection ×©×œ ×”××©×ª××©
  async function addTransaction(type, item, price, date) {
    if (!currentUserUID) {
      alert('××™×Ÿ ××©×ª××© ××—×•×‘×¨.');
      return;
    }
    try {
      cleanAfterAction();
      const txCollection = collection(db, "users", currentUserUID, "transactions");
      const docRef = await addDoc(txCollection, {
        type,
        item: item.trim(),
        price: Number(price),
        date
      });
      // ×œ× ×—×™×™×‘×™× ×œ×“×—×•×£ ×œÖ¾transactions ×›×™ onSnapshot ×™×¢×“×›×Ÿ ××•×ª× ×•, ××‘×œ × ×©××™×¨ ×¢×“×›×•×Ÿ ××§×•××™ ×§×œ ×‘××§×¨×” ×©××™×Ÿ onSnapshot
      // transactions.push({ id: docRef.id, type, item: item.trim(), price: Number(price), date });
      // refreshUI();
    } catch (e) {
      console.error('addTransaction error:', e);
      alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×¢×¡×§×”: ' + e.message);
    }
  }

  // ×¢×“×›×•×Ÿ ×¢×¡×§×” ×‘-subcollection
  async function editTransaction(id, newData) {
    if (!currentUserUID) {
      alert('××™×Ÿ ××©×ª××© ××—×•×‘×¨.');
      return;
    }
    try {
      const txDoc = doc(db, "users", currentUserUID, "transactions", id);
      await updateDoc(txDoc, newData);
      // onSnapshot ×™×¢×“×›×Ÿ ××•×ª× ×• ××•×˜×•××˜×™×ª
    } catch (e) {
      console.error('editTransaction error:', e);
      alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢×¡×§×”: ' + e.message);
    }
  }

  // ××—×™×§×ª ×¢×¡×§×” ×‘-subcollection
  async function deleteTransaction(id) {
    if (!currentUserUID) {
      alert('××™×Ÿ ××©×ª××© ××—×•×‘×¨.');
      return;
    }
    try {
      const txDoc = doc(db, "users", currentUserUID, "transactions", id);
      await deleteDoc(txDoc);
      // onSnapshot ×™×¢×“×›×Ÿ ××•×ª× ×• ××•×˜×•××˜×™×ª
    } catch (e) {
      console.error('deleteTransaction error:', e);
      alert('×©×’×™××” ×‘××—×™×§×ª ×¢×¡×§×”: ' + e.message);
    }
  }

  /* ===========================
     Auth: ×”×ª×—×‘×¨×•×ª/×”×¨×©××”/×”×ª× ×ª×§×•×ª + onAuthStateChanged
     =========================== */

  loginBtn?.addEventListener('click', async () => {
    try {
      await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    } catch (e) {
      alert('×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ' + e.message);
    }
  });

  signupBtn?.addEventListener('click', async () => {
    try {
      await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      alert("× ×¨×©××ª ×‘×”×¦×œ×—×”! âœ…");
    } catch (e) {
      alert('×©×’×™××ª ×”×¨×©××”: ' + e.message);
    }
  });

  logoutBtn?.addEventListener('click', async () => {
    try {
      await signOut(auth);
    } catch (e) {
      console.error('signOut error', e);
    }
  });

  // ×××–×™×Ÿ ×œ××¦×‘ ×”××™××•×ª â€” ××¤×¢×™×œ/××¤×¡×™×§ ××ª ×××–×™×Ÿ ×”×¢×¡×§××•×ª
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUserUID = user.uid;
      loginModal?.classList.add('hidden');
      logoutBtn?.classList.remove('hidden');
      // ×”×ª×—×œ ×œ×”×§×©×™×‘ ×œ×©×™× ×•×™×™× ×‘×¢×¡×§××•×ª ×©×œ ×”××©×ª××©
      listenToUserTransactions(currentUserUID);
    } else {
      currentUserUID = null;
      loginModal?.classList.remove('hidden');
      logoutBtn?.classList.add('hidden');
      // ×¢×¦×•×¨ ××ª ×”×××–×™×Ÿ ×× ×§×™×™×
      if (transactionsUnsubscribe) {
        transactionsUnsubscribe();
        transactionsUnsubscribe = null;
      }
      transactions = [];
      refreshUI();
    }
  });

}); // end DOMContentLoaded
</script>






</body>
</html>
